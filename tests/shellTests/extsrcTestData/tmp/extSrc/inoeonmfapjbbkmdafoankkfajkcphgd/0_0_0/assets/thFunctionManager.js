this.thFunctionManager=function(){this._service=null,this._tracker=null,this._license=null,this._timing=[],this._firstChromeStart=!0,this._links={},this._onInstalled={},this.initialise=function(){try{this._service=analytics.getService('RW4GC'),this._tracker=this._service.getTracker('UA-83720712-1'),chrome.storage.managed.get(null,(a)=>{texthelp.RW4GC.IdentityManagerInstance=new texthelp.RW4GC.IdentityManager(a.accountType)}),texthelp.RW4GC.MessagingManagerInstance=new texthelp.RW4GC.MessagingManager(texthelp.RW4GC.enums.MessagingType.GCM),this._onInstalled=this.onInstall.bind(this),chrome.runtime.onInstalled.addListener(this._onInstalled)}catch(a){console.log(a)}},this.onInstall=function(){chrome.runtime.onInstalled.removeListener(this._onInstalled),texthelp.RW4GC.IdentityManagerInstance.getLicenseNoCache(!1,(a)=>{try{if(a==void 0)return;if(void 0!==a.error)return;/*         var parameters = [];

                if (details.reason == "install") {
                    parameters.push('installed');
                } else if (details.reason == "update") {
                    //          parameters.push("Updated from " + details.previousVersion + " to " + chrome.runtime.getManifest().version);
                    parameters.push('updated');
                }

                parameters.push(license.Email);
                parameters.push(license.Email.split('@')[1]);

                this.onSendEvent(parameters);*/}catch(a){}})},this.onRefreshLicense=function(a,b){texthelp.RW4GC.IdentityManagerInstance.getLicenseNoCache(!1,(a)=>{b({type:'1757FROM_BGRW4G',method:'onRefreshLicense',payload:{license:JSON.stringify(a)}})})},this.onAuthenticate=function(){try{/*      
                   texthelp.RW4GC.IdentityManagerInstance.getLicense(true, (license) => {
                     
                   });
                   // TODO: oauth

                /*   texthelp.RW4GC.authenticator.getEmail(true, function (email) {
                       texthelp.RW4GC.authenticator.getLicense(email, function (license) {
                           //           console.log(license);
                       }.bind(this));
                   }.bind(this));*/}catch(a){console.log(a)}},this.onCollectHighlights=function(a){try{'https://rw.texthelp.com/simplify/home/simplify'==a.url.split('?')[0]&&(a.url=a.url.split('simplify=')[1],a.title=a.url),this.params=a,texthelp.RW4GC.IdentityManagerInstance.collectHighlights(a,(a)=>{var b=window.open(a,'_blank');b.focus()})}catch(a){console.log(a)}},this.onVocab=function(a){try{texthelp.RW4GC.IdentityManagerInstance.vocab(a,(a)=>{var b=window.open(a,'_blank');b.focus()})}catch(a){console.log(a)}},this.onAddVoiceNote=function(a,b,c,d){try{if(!d.url.startsWith('https://docs.google.com/document'))return;texthelp.RW4GC.IdentityManagerInstance.getVoiceNoteOAuthToken(a,(a)=>{b({type:'1757FROM_BGRW4G',method:'onAddVoiceNoteToken',parameters:{token:a}})})}catch(a){console.log(a)}},this.onBarShown=function(a){try{texthelp.RW4GC.IdentityManagerInstance.onBarVisible(),texthelp.RW4GC.IdentityManagerInstance.getLicense(!0,(b)=>{var c=[];c.push(a[0]),c.push(b),this.onSendAppView(c);var c=[];if(c.push('toolbar down'),c.push(b.Email),c.push(b.Email.split('@')[1]),this.onSendEvent(c),0<=a[1].indexOf('https://docs.google.com/document/')&&0<=a[1].indexOf('/edit')){var c=[];c.push(a[1]),c.push(b.Email),c.push(b.Email.split('@')[1]),this.onSendEvent(c)}texthelp.RW4GC.IdentityManagerInstance.onBarShown()})}catch(a){console.log(a)}},this.onOpenTab=function(a){if(a.startsWith('https://largemp3.speechstream.net/')){var b=window.open(a,'_MP3Test3452');b.focus()}},this.openForm=function(a,b,c,d){var e=document.createElement('form');if(e.action=b,e.method=a,e.setAttribute('method','post'),e.enctype='application/x-www-form-urlencoded',e.target=d||'_blank',c)for(var f in c){var g=document.createElement('textarea');g.name=f,g.value='object'==typeof c[f]?JSON.stringify(c[f]):c[f],e.appendChild(g)}e.style.display='none',document.body.appendChild(e),e.submit()},this.onOpenPracticeReadingAloud=function(a){this.openForm('POST','https://fluency.texthelp.com/ReadWrite',a)},this.onSaveBarSettings=function(a){chrome.storage.sync.set({texthelpbar:a})},this.onLoadBarSettings=function(a,b){chrome.storage.sync.get({texthelpbar:a},function(c){null==c.texthelpbar&&(c.texthelpbar=a),b({type:'1757FROM_BGRW4G_FUNCTION',method:'LoadBarSettings',parameters:{texthelpbar:c.texthelpbar}})})},this.onSaveDialogSettings=function(a){chrome.storage.sync.set({texthelpdialogs:a})},this.onLoadDialogSettings=function(a,b){chrome.storage.sync.get({texthelpdialogs:a},function(c){null==c.texthelpdialogs&&(c.texthelpdialogs=a),b({type:'1757FROM_BGRW4G_FUNCTION',method:'LoadDialogSettings',parameters:{texthelpdialogs:c.texthelpdialogs}})})},this.onStartTiming=function(){},this.onEndTiming=function(){},this.onNewLicense=function(a){try{var b=[];if(null!==this._license)return;this._license=a;var c=!1;a.trial!==void 0&&(c=a.trial);var d=!1;a.unlimited!==void 0&&(d=a.unlimited),0<a.daysleft&&!c?b.push('premium'):0<a.daysleft&&c?b.push('trial'):b.push('freemium'),b.push(a.Email.toLowerCase()),b.push(a.Email.split('@')[1].toLowerCase()),b.push(1),this.onSendEvent(b),b.length=0,d?b.push('domain'):'group'==a.licence_type.toLowerCase()?b.push('group'):b.push('single'),b.push(a.Email.toLowerCase()),b.push(a.Email.split('@')[1].toLowerCase()),b.push(1),this.onSendEvent(b),b.length=0,b.push('ltype:'+a.lType.toLowerCase()),b.push(a.Email.toLowerCase()),b.push(a.Email.split('@')[1].toLowerCase()),b.push(1),this.onSendEvent(b)}catch(a){console.log(a)}},this.onSendAppView=function(a){if(null!=this._tracker){this.onNewLicense(a[1]),console.log('SendAppView: '+a[0].toLowerCase());try{var b=thHash.hashEmail(a[1].Email.toLowerCase());this._tracker.set('userId',b)}catch(a){}this._tracker.sendAppView(a[0].toLowerCase())}// track the new license. If this was called 
},this.onSendEvent=function(a){if(null!=this._tracker)return-1<a[1].indexOf('@')&&(a[1]=thHash.hashEmail(a[1])),4==a.length?(this._tracker.set('userId',a[1].toLowerCase()),this._tracker.sendEvent(a[0],a[1].toLowerCase(),a[2].toLowerCase(),a[3]),void console.log('SendEvent: '+a[0]+':'+a[1].toLowerCase()+':'+a[2].toLowerCase()+':'+a[3])):void(console.log('SendEvent: '+a[0]+':'+a[1].toLowerCase()+':'+a[2].toLowerCase()),this._tracker.set('userId',a[1].toLowerCase()),this._tracker.sendEvent(a[0],a[1].toLowerCase(),a[2].toLowerCase()))},this.onGetLocaleDate=function(a,b){var c=moment(a[1]);c.locale(a[0]);var d=c.format('DD MMMM YYYY');moment(a[1]),b({type:'1757FROM_BGRW4G',method:'onGetLocaleDate',payload:{date:d}})},this.onActivateProductCode=function(a,b){texthelp.RW4GC.IdentityManagerInstance.setproductCode(a[0],(a)=>{b({type:'1757FROM_BGRW4G',method:'onRefreshLicense',payload:{license:JSON.stringify(a)}})})}},this.thFunctions==void 0&&(this.thFunctions=new this.thFunctionManager,this.thFunctions.initialise());