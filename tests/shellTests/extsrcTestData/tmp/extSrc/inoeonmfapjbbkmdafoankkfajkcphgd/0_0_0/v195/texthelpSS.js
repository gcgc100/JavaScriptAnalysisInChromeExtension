function $rw_barSSInit(){SSDAT.paths.strFileLoc;if((g_nIcons&collect_icon)==collect_icon||(g_nNoDisplayIcons&collect_icon)==collect_icon){g_bIE;var e="";e+="<span texthelpStopContinuous=\"1\"></span>",SSDOM.BetterInnerHTML(SSDAT.pageData.placeholder,e,!1)}g_bSSLoaded=!0,"function"==typeof $rw_toolbarHighlightLoadedCallback&&$rw_toolbarHighlightLoadedCallback()}if($rw_barSSInit(),"undefined"==typeof g_aTextRange)var g_aTextRange=[];if("undefined"==typeof g_aHighlightColour)var g_aHighlightColour=[];var g_showTHCHDialog=!1;function studySkillsHTMLHighlightRange(e){try{var t=rw_getSelection();if(null==t||null==t.range||t.range instanceof String)return!1;var n=t.range;if(g_bIEOld){var o=n.parentElement().ownerDocument.body,i=rw_getTextRangeAsTHRange(o,n);if(null==i)return!1;var d=SSDOM.getCaretPairFromDomPosition(o,i.startRef.path,i.startRef.offset,i.endRef.path,i.endRef.offset),s=d.leftCaret,l=d.rightCaret;if(null==s||null==l)return!1;var a=new THDomRange(s.node,s.offset,l.node,l.offset);if(null==a)return null;if(a=rw_checkTHRangeForValidHighlight(a),null==a)return null;n=rw_getAsTextRange(o,a.startRef.path,a.startRef.offset,a.endRef.path,a.endRef.offset)}else n=rw_checkTHRangeForValidHighlight(n);return null==n?(rw_alert("Failed to do the highlight, possibly due to selection going into a non textual part of the page."),!1):(studySkillsHTMLHighlightRangeImpl(n,e),rw_collapseSelection(),g_bPersistAnnotations&&g_bPersistHighlights&&"undefined"!=typeof rw_storeHighlightData&&rw_storeHighlightData(),!0)}catch(e){return!1}}function rw_checkTHRangeForValidHighlight(e){var t=e.startCaret,n=e.endCaret,o=!1;if(SSDOM.isInvalidNode(t.node))if(t.node!=n.node){var i=SSDOM.getNextTextNodeNoImg(t.node,!1,n.node,!1);if(null!=i&&!SSDOM.isInvalidNode(i))t.node=i,t.offset=0,o=!0;else return}else return;var d=3!=t.node.nodeType||3==t.node.nodeType&&0==t.node.nodeValue.trimTH().length;if(d){for(o=!0;d;){if(t.node==n.node)return null;if(t.node=SSDOM.getNextTextNodeNoBlank(t.node,!1,n.node),null==t.node)return null;d=3!=t.node.nodeType||3==t.node.nodeType&&0==t.node.nodeValue.trimTH().length}t.offset=0}if(SSDOM.isInvalidNode(n.node))if(t.node!=n.node){var i=SSDOM.getPreviousTextNodeNoImg(n.node,!1,t.node,!1);if(null!=i&&!SSDOM.isInvalidNode(i))n.node=i,n.offset=i.nodeValue.length,o=!0;else return}else return;if(d=3!=n.node.nodeType||3==n.node.nodeType&&0==n.node.nodeValue.trimTH().length,d){for(o=!0;d;){if(t.node==n.node)return null;if(n.node=SSDOM.getPreviousTextNodeNoImg(n.node,!1,t.node,!1),null==n.node)return null;d=3!=n.node.nodeType||3==n.node.nodeType&&0==n.node.nodeValue.trimTH().length}3==n.node.nodeType&&(n.offset=n.node.nodeValue.length)}return null==t.node||null==n.node?null:(o&&(e=new THDomRange(t.node,t.offset,n.node,n.offset)),e)}function studySkillsHTMLHighlightRangeImpl(e,t){try{var n=!1,o=null,i=null,d=null,s=!0;if(null==e||e instanceof String)return;var l=0,a=!1;if(g_bIEOld){if(d=rw_getTextFromRange(e),0==d.length)return;try{o=e.parentElement();var c=SSDOM.getComputedStyle(o);if(null!=c&&"none"==c.display)n=!0;else for(var r=o.ownerDocument.body;o!=r;)if(o=o.parentNode,"none"==SSDOM.getComputedStyle(o).display){n=!0;break}n&&(i=o.style.display,o.style.display="inline")}catch(t){}studySkillsHTMLRefreshRanges();for(var g=0;g<g_aTextRange.length;g++){var h=g_aTextRange[g],u=e.duplicate();u.collapse(!0);var f=h.inRange(u);u=e.duplicate(),u.collapse(!1);var p=h.inRange(u);a=!1,f&&p?g_aHighlightColour[g]==t?s=!1:(case1IE(g,e),a=!0):!f&&p?(case2IE(g,e),a=!0):f&&!p?(case3IE(g,e),a=!0):e.inRange(h)&&(g_aTextRange.splice(g,1),g_aHighlightColour.splice(g,1),g--,a=!0),a&&(++l,100>l&&(g=-1))}}else if(e.toString){if(null==e||null==e.toString()||""==e.toString())return;for(var b,g=0;g<g_aTextRange.length;g++){if(b=g_aTextRange[g],e.body.ownerDocument==b.body.ownerDocument){var m=e.compareRange(b);switch(m){case THDomRange_ERROR:window.status="Error occurred when trying to add a highlight.";break;case THDomRange_TARGET_SAME:if(g_aHighlightColour[g]==t){s=!1;break}case THDomRange_TARGET_INSIDE:b.refresh(),rw_removeHighlight(SSDOM.getListOfHighlightableNodes(b.startCaret,b.endCaret)),g_aTextRange.splice(g,1),g_aHighlightColour.splice(g,1),--g,e.refresh(),a=!0;break;case THDomRange_TARGET_INCLUDES_THIS:case THDomRange_TARGET_INCLUDES_THIS_AT_START:case THDomRange_TARGET_INCLUDES_THIS_AT_END:g_aHighlightColour[g]==t?s=!1:(case1SFF(g,e,m),++g,a=!0);break;case THDomRange_OVERLAPS_START_OF_TARGET:case2SFF(g,e),a=!0;break;case THDomRange_OVERLAPS_END_OF_TARGET:case3SFF(g,e),a=!0;break;case THDomRange_AFTER_TARGET:break;case THDomRange_BEFORE_TARGET:break;default:}}a&&(++l,100>l&&(g=-1))}}else return;if(g_bIENew&&rw_collapseSelection(),s){if(e.execCommand)studySkillsClearRangeIE(e),rw_ieSpecificCallToSetHighlight(e,t);else var x=e.startCaret,k=e.endCaret,S=rw_setHighlight(x.node,x.offset,k.node,k.offset,t);g_aTextRange.push(e),g_aHighlightColour.push(t)}return rw_collapseSelection(),n&&(o.style.display=i),!0}catch(e){return!1}}function rw_ieSpecificCallToSetHighlight(e,t){"strikethrough"==t?e.execCommand("strikethrough",!1,null):e.execCommand("backcolor",!1,t)}function case1IE(e,t){var n=g_aTextRange[e].duplicate(),o=g_aTextRange[e].duplicate();for(n.collapse(!0),o.collapse(!1);0>n.compareEndPoints("EndToStart",t);)n.moveEnd("character",1);for(;0<o.compareEndPoints("StartToEnd",t);)o.moveStart("character",-1);studySkillsClearRangeIE(g_aTextRange[e]),0==n.text.length?(g_aTextRange[e]=o,rw_ieSpecificCallToSetHighlight(g_aTextRange[e],g_aHighlightColour[e])):(g_aTextRange[e]=n,rw_ieSpecificCallToSetHighlight(g_aTextRange[e],g_aHighlightColour[e]),0<o.text.length&&(g_aTextRange.push(o),g_aHighlightColour.push(g_aHighlightColour[e]),rw_ieSpecificCallToSetHighlight(o,g_aHighlightColour[e])))}function case2IE(e,t){var n=g_aTextRange[e].duplicate();for(n.collapse(!1);0<n.compareEndPoints("StartToEnd",t);)n.moveStart("character",-1);g_aTextRange[e]=n}function case3IE(e,t){var n=g_aTextRange[e].duplicate();for(n.collapse(!0);0>n.compareEndPoints("EndToStart",t);)n.moveEnd("character",1);g_aTextRange[e]=n}function case1SFF(e,t,n){var o=g_aHighlightColour[e],i=g_aTextRange[e];i.refresh();var d=i.startRef,s=t.startRef,l=t.endRef,a=i.endRef;rw_removeHighlight(SSDOM.getListOfHighlightableNodes(i.startCaret,i.endCaret)),g_aTextRange.splice(e,1),g_aHighlightColour.splice(e,1);var c,r,g,h;n!=THDomRange_TARGET_INCLUDES_THIS_AT_START&&(caretRange=SSDOM.getCaretPairFromDomPosition(t.body,d.path,d.offset,s.path,s.offset),c=caretRange.leftCaret,r=caretRange.rightCaret,g=rw_setHighlight(c.node,c.offset,r.node,r.offset,o),h=new THDomRange(g.start,0,g.end,g.end.nodeValue.length),g_aTextRange.push(h),g_aHighlightColour.push(o)),n!=THDomRange_TARGET_INCLUDES_THIS_AT_END&&(caretRange=SSDOM.getCaretPairFromDomPosition(t.body,l.path,l.offset,a.path,a.offset),c=caretRange.leftCaret,r=caretRange.rightCaret,g=rw_setHighlight(c.node,c.offset,r.node,r.offset,o),h=new THDomRange(g.start,0,g.end,g.end.nodeValue.length),g_aTextRange.push(h),g_aHighlightColour.push(o)),t.refresh()}function case2SFF(e,t){var n=g_aHighlightColour[e],o=g_aTextRange[e];o.refresh();var i=t.endRef,d=o.endRef;rw_removeHighlight(SSDOM.getListOfHighlightableNodes(o.startCaret,o.endCaret)),g_aTextRange.splice(e,1),g_aHighlightColour.splice(e,1);var s=SSDOM.getCaretPairFromDomPosition(t.body,i.path,i.offset,d.path,d.offset),l=s.leftCaret,a=s.rightCaret,c=rw_setHighlight(l.node,l.offset,a.node,a.offset,n),r=new THDomRange(c.start,0,c.end,c.end.nodeValue.length);g_aTextRange.push(r),g_aHighlightColour.push(n),t.refresh()}function case3SFF(e,t){var n=g_aHighlightColour[e],o=g_aTextRange[e];o.refresh();var i=o.startRef,d=t.startRef;rw_removeHighlight(SSDOM.getListOfHighlightableNodes(o.startCaret,o.endCaret)),g_aTextRange.splice(e,1),g_aHighlightColour.splice(e,1);var s=SSDOM.getCaretPairFromDomPosition(t.body,i.path,i.offset,d.path,d.offset),l=s.leftCaret,a=s.rightCaret,c=rw_setHighlight(l.node,l.offset,a.node,a.offset,n),r=new THDomRange(c.start,0,c.end,c.end.nodeValue.length);g_aTextRange.push(r),g_aHighlightColour.push(n),t.refresh()}function testRange(e){var t="";t+="range.collapse="+e.collapse+"\n",t+="range.duplicate="+e.duplicate+"\n",t+="range.inRange="+e.inRange+"\n",t+="range.text="+e.text+"\n",t+="range.compareEndPoints="+e.compareEndPoints+"\n",rw_alert(t)}function studySkillsClearHighlights(e){try{var t=rw_getSelection(),n=null,o=null;if(null!=t&&null!=t.range&&(n=t.range,o=t.frame),null!=n&&n instanceof String)if(null!=g_lastInputSelectSFF&&(g_lastInputSelectSFF.selectionStart=0,g_lastInputSelectSFF.selectionEnd=0),g_lastInputSelectSFF=null,e)n=null;else return;if(g_bIEOld){if(null==n||0==n.length||0==n.text.length||e){if(!e){var d=confirm(textHelp.webreader.LocaleSingleton.getInst().getLocaleString("speechstream_msh_removehighlights"));if(!d)return}g_bPersistAnnotations&&(g_strStoredHighlightData=null,g_strStoredHighlightUnprocessedData=null);for(var s,l=g_aTextRange.length,a=0;a<l;a++)s=g_aTextRange[a],studySkillsClearRangeIE(s),g_aTextRange[a]=null,g_aHighlightColour[a]=null;if(g_aTextRange=[],g_aHighlightColour=[],!document.compatMode.equalsTH("CSS1Compat"))if(!g_bIgnoreFrames&&0<top.frames.length){var c=0,i=top.frames.length;for(c=0;c<i;c++)try{var r=top.frames[c];n=r.document.selection.createRange(),n.expand("textedit"),studySkillsClearRangeIE(n)}catch(t){}}else n=document.selection.createRange(),n.expand("textedit"),studySkillsClearRangeIE(n);return void(g_bPersistAnnotations&&g_bPersistHighlights&&"undefined"!=typeof rw_storeHighlightData&&rw_storeHighlightData())}studySkillsClearRangeIE(n),studySkillsHTMLRefreshRanges();var l=g_aTextRange.length,a=0,g=null,h=null;for(a=0;a<l;a++)if(g=g_aTextRange[a],null!=g){if(n.inRange(g)){g=null,g_aTextRange.splice(a,1),g_aHighlightColour.splice(a,1),a--;continue}if(h=g.duplicate(),h.collapse(!0),n.inRange(h)){var u=g.duplicate();for(u.collapse(!1);0<u.compareEndPoints("StartToEnd",n);)u.moveStart("character",-1);studySkillsClearRangeIE(g_aTextRange[a]),g_aTextRange[a]=u,rw_ieSpecificCallToSetHighlight(g_aTextRange[a],g_aHighlightColour[a])}else if(h=g.duplicate(),h.collapse(!1),n.inRange(h)){var f=g.duplicate();for(f.collapse(!0);0>f.compareEndPoints("EndToStart",n);)f.moveEnd("character",1);studySkillsClearRangeIE(g_aTextRange[a]),g_aTextRange[a]=f,rw_ieSpecificCallToSetHighlight(g_aTextRange[a],g_aHighlightColour[a])}if(g.inRange(n)){studySkillsClearRangeIE(g);var f=g.duplicate(),u=g.duplicate();for(f.collapse(!0),u.collapse(!1);0>f.compareEndPoints("EndToStart",n);)f.moveEnd("character",1);for(;0<u.compareEndPoints("StartToEnd",n);)u.moveStart("character",-1);studySkillsClearRangeIE(g_aTextRange[a]),g_aTextRange[a]=f,g_aTextRange.push(u),g_aHighlightColour.push(g_aHighlightColour[a]),rw_ieSpecificCallToSetHighlight(f,g_aHighlightColour[a]),rw_ieSpecificCallToSetHighlight(u,g_aHighlightColour[a])}}n.execCommand("UnSelect",!1,null)}else{if(null==n||e){if(!e){var d=confirm(textHelp.webreader.LocaleSingleton.getInst().getLocaleString("speechstream_msh_removehighlights"));if(!d)return}g_bPersistAnnotations&&(g_strStoredHighlightData=null,g_strStoredHighlightUnprocessedData=null);var p=g_aTextRange;g_aTextRange=[],g_aHighlightColour=[];for(var g,c=0;c<p.length;c++)g=p[c],g.refresh(),rw_removeHighlight(SSDOM.getListOfHighlightableNodes(g.startCaret,g.endCaret))}else{n.refresh();for(var b,a=0;a<g_aTextRange.length;a++)if(b=g_aTextRange[a],n.body==b.body){var m=n.compareRange(b);switch(m){case THDomRange_ERROR:window.status="Error occurred when trying to remove a highlight.";break;case THDomRange_TARGET_SAME:case THDomRange_TARGET_INSIDE:b.refresh(),rw_removeHighlight(SSDOM.getListOfHighlightableNodes(b.startCaret,b.endCaret)),g_aTextRange.splice(a,1),g_aHighlightColour.splice(a,1),--a,n.refresh();break;case THDomRange_TARGET_INCLUDES_THIS:case THDomRange_TARGET_INCLUDES_THIS_AT_START:case THDomRange_TARGET_INCLUDES_THIS_AT_END:case1SFF(a,n,m),++a;break;case THDomRange_OVERLAPS_START_OF_TARGET:case2SFF(a,n);break;case THDomRange_OVERLAPS_END_OF_TARGET:case3SFF(a,n);break;case THDomRange_AFTER_TARGET:break;case THDomRange_BEFORE_TARGET:break;default:}}}rw_collapseSelection()}g_bPersistAnnotations&&g_bPersistHighlights&&"undefined"!=typeof rw_storeHighlightData&&rw_storeHighlightData(),g_abVisible[POPUP_COLLECT]&&$rw_divPress(POPUP_COLLECT)}catch(e){thLog("Error in method: "+e.name+" "+e.message+" "+e.description+" "+e.toString())}}function studySkillsClearRangeIE(e){e.execCommand("backcolor",!1,"clear"),(g_nIcons&strike_icon)==strike_icon&&e.execCommand("RemoveFormat",!1,null)}function sortBy(e,t){try{return e.compareEndPoints("EndToEnd",t)}catch(e){return thLog("sortby "+e.message),0}}function sortBySFF(e,t){try{if(e.equals(t))return 0;e.refresh(),t.refresh();var n=e.getEndAsRange(),o=t.getEndAsRange();return n.compareBoundaryPoints("END_TO_END",o)}catch(e){return thLog("sortBySFF "+e.message),0}}var g_eventSubScribeID,g_eventSubScribeCollectID,g_eventSubScribeVocabID;function showDialog(){g_eventSubScribeID=textHelp.webreaderapi.EventBusSingleton.getInst().subscribe("onGetSettingsChanged",this.onGetSettingsChanged,this),textHelp.webreader.UserSettingsSingleton.getInst().updateUserSettings()}function hasClassName(e,t){return e.classList.contains(t)}function changeClassName(e,t,n){e.classList.remove(t),e.classList.add(n)}function showDialogwithSetting(e){var t=Math.round,n=document.querySelector("#thSSCHODialog");if(null!==n)return void(g_showTHCHDialog=!1);n=document.createElement("div"),n.id="thSSCHODialog",n.className="gdwr-modal-dialog-bg";var o="opacity: 0.5; width: "+document.body.clientWidth+"px; height: "+document.body.clientHeight+"px;";n.setAttribute("style",o),dialog=document.createElement("div"),dialog.className="gdwr-modal-dialog gdwr-collecthighlights-dialog",dialog.id="thCHDialog";var d=t(screen.width/2)-125,s=t(screen.height/2)-160;o="left: "+d+"px; top: "+s+"px;",dialog.setAttribute("style",o),dialog.innerHTML="<div class=\"gdwr-modal-dialog-title\" id=\":0\"><span class=\"gdwr-modal-dialog-title-text\" data-speechstream-collecthighlights-dialog=\"speechstream_collect_highlights_dialog_heading\">Collect Highlights</span><span class=\"gdwr-modal-dialog-title-close\"></span></div><div class=\"gdwr-modal-dialog-content\"><div class=\"thchitems\"><div class=\"sortLabel\" data-speechstream-collecthighlights-dialog=\"speechstream_collecthighlights_sort\">Sort highlights by</div><select id=\"sortSelect\" class=\"thSelect\"><option value=\"0\" data-speechstream-collecthighlights-dialog=\"speechstream_collecthighlights_color\">color</option><option value=\"1\" data-speechstream-collecthighlights-dialog=\"speechstream_collecthighlights_position\">position</option></select><div class=\"thchcolors\"><span data-speechstream-collecthighlights-dialog=\"speechstream_collecthighlights_to_collect\">Colors to collect</span><div><div id=\"thYellowChk\" class=\"thCollectChks thYellowChk goog-checkbox-checked goog-checkbox\" tabindex=\"0\" aria-checked=\"true\" role=\"checkbox\" style=\"-webkit-user-select: none;\"><div class=\"thRects thYellowRect\"></div></div><br><div id=\"thBlueChk\" class=\"thCollectChks thBlueChk goog-checkbox-checked goog-checkbox\" tabindex=\"0\" aria-checked=\"true\" role=\"checkbox\" style=\"-webkit-user-select: none;\"><div class=\"thRects thBlueRect\"></div></div><br><div id=\"thGreenChk\" class=\"thCollectChks thGreenChk goog-checkbox-checked goog-checkbox\" style=\"-webkit-user-select: none;\" 0\"=\"\" aria-checked=\"true\" role=\"checkbox\" tabindex=\"0\"><div class=\"thRects thGreenRect\"></div></div><br><div id=\"thPinkChk\" class=\"thCollectChks thPinkChk goog-checkbox-checked goog-checkbox\" tabindex=\"0\" aria-checked=\"true\" role=\"checkbox\" style=\"-webkit-user-select: none;\"><div class=\"thRects thPinkRect\"></div></div><br></div></div></div><div class=\"gdwr-modal-dialog-buttons gdwr-collect-dialog-buttons\"><button class=\"goog-button gdwr-dialog-button\" title=\"\" value=\"\" data-speechstream-collecthighlights-dialog=\"dialog_Cancel\">Cancel</button><button class=\"goog-button gdwr-dialog-button\" title=\"\" value=\"\" data-speechstream-collecthighlights-dialog=\"dialog_OK\">OK</button></div></div><div class=\"gdwr-modal-dialog-buttons\" style=\"display: none;\"></div>";var l=document.getElementById("thSpeechStreamTBPlaceHolder");l.appendChild(n),l.appendChild(dialog);var a=e.sortAlgorithm,c=document.querySelector("#sortSelect");c.selectedIndex=a;var r=document.querySelector("#thYellowChk");!0!==e.yellow&&e.yellow!==void 0&&changeClassName(r,"goog-checkbox-checked","goog-checkbox-unchecked"),r.addEventListener("click",function(){hasClassName(r,"goog-checkbox-checked")?changeClassName(r,"goog-checkbox-checked","goog-checkbox-unchecked"):changeClassName(r,"goog-checkbox-unchecked","goog-checkbox-checked")},!0);var g=document.querySelector("#thBlueChk");!0!==e.blue&&e.blue!==void 0&&changeClassName(g,"goog-checkbox-checked","goog-checkbox-unchecked"),g.addEventListener("click",function(){hasClassName(g,"goog-checkbox-checked")?changeClassName(g,"goog-checkbox-checked","goog-checkbox-unchecked"):changeClassName(g,"goog-checkbox-unchecked","goog-checkbox-checked")},!0);var h=document.querySelector("#thGreenChk");!0!==e.green&&e.green!==void 0&&changeClassName(h,"goog-checkbox-checked","goog-checkbox-unchecked"),h.addEventListener("click",function(){hasClassName(h,"goog-checkbox-checked")?changeClassName(h,"goog-checkbox-checked","goog-checkbox-unchecked"):changeClassName(h,"goog-checkbox-unchecked","goog-checkbox-checked")},!0);var u=document.querySelector("#thPinkChk");!0!==e.pink&&e.pink!==void 0&&changeClassName(u,"goog-checkbox-checked","goog-checkbox-unchecked"),u.addEventListener("click",function(){hasClassName(u,"goog-checkbox-checked")?changeClassName(u,"goog-checkbox-checked","goog-checkbox-unchecked"):changeClassName(u,"goog-checkbox-unchecked","goog-checkbox-checked")},!0),dialog.addEventListener("click",function(e){var t=e.target.nodeName,n=e.target.innerText;"BUTTON"==t&&("OK"===n?onOKCHDialog():onCancelCHDialog())},!0);for(var f,p=dialog.querySelectorAll("[data-speechstream-collecthighlights-dialog]"),b=0;b<p.length;b++)f=p[b].getAttribute("data-speechstream-collecthighlights-dialog"),p[b].innerText=textHelp.webreader.LocaleSingleton.getInst().getLocaleString(f)}var g_collectHighlightsTab,g_vocabTab;function onOKCHDialog(){textHelp.webreaderapi.EventBusSingleton.getInst().unsubscribe(g_eventSubScribeID);var e=textHelp.webreader.UserSettingsSingleton.getInst().getUserSettings(),t=document.querySelector("#sortSelect");e.collecthighlights.sortAlgorithm=t.selectedIndex;var n=document.querySelector("#thYellowChk");e.collecthighlights.yellow=!!hasClassName(n,"goog-checkbox-checked");var o=document.querySelector("#thBlueChk");e.collecthighlights.blue=!!hasClassName(o,"goog-checkbox-checked");var i=document.querySelector("#thGreenChk");e.collecthighlights.green=!!hasClassName(i,"goog-checkbox-checked");var d=document.querySelector("#thPinkChk");e.collecthighlights.pink=!!hasClassName(d,"goog-checkbox-checked"),textHelp.webreader.UserSettingsSingleton.getInst().saveUserSettings(e);var s=document.querySelector("#thCHDialog");null!==s&&s.parentNode.removeChild(s);var l=document.querySelector("#thSSCHODialog");null!==l&&l.parentNode.removeChild(l),g_showTHCHDialog=!1;var a=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("collect_highlights_notification"),c=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("collect_highlights_notification_text"),r=window.notification({msg:"<div><div class=\"vl-notification\"><div class=\"vl-notification-content\"><div class=\"vl-notification-heading\">"+a+"</div><div class=\"vl-notification-msg\">"+c+"</div></div></div></div>",sticky:!0,type:"success",animIn:"fadeInRight",animOut:"fadeOutDown"});g_collectHighlightsTab=window.open("","_blank");var g={sortBy:t.selectedIndex,yellow:e.collecthighlights.yellow,blue:e.collecthighlights.blue,green:e.collecthighlights.green,pink:e.collecthighlights.pink,title:document.getElementsByTagName("title")[0].innerHTML,url:window.location.href};collectHighlightsWithSettings(g,r)}function collectHighlightsWithSettings(e,t){return 0==e.sortBy?void collectHighlightsByColor(e,t):void collectHighlightsByPosition(e,t)}var g_notifID=null;function collectHighlightsByColor(e,t){var n=[];e.yellow&&(n=n.concat(studySkillsCollateForColour(["yellow"]))),e.blue&&(n=n.concat(studySkillsCollateForColour(["blue"]))),e.green&&(n=n.concat(studySkillsCollateForColour(["green"]))),e.pink&&(n=n.concat(studySkillsCollateForColour(["pink"])));var o=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("ch_documentTitle"),i={highlights:n,title:document.getElementsByTagName("title")[0].innerHTML,url:window.location.href,docTitle:o};g_notifID=t,g_eventSubScribeCollectID=textHelp.webreaderapi.EventBusSingleton.getInst().subscribe("onCollectHighlightsWeb",this.onCollectHighlightsWeb,this),window.postMessage({method:"collectHighlightsWeb",type:"1757FROM_PAGERW4G",documentHighlights:i},"*")}function collectHighlightsByPosition(e,t){var n=[],o=[],n=[];e.yellow&&o.push("yellow"),e.blue&&o.push("blue"),e.green&&o.push("green"),e.pink&&o.push("pink"),n=n.concat(studySkillsCollateForColour(o));var i={highlights:n,title:document.getElementsByTagName("title")[0].innerHTML,url:window.location.href};g_notifID=t,g_eventSubScribeCollectID=textHelp.webreaderapi.EventBusSingleton.getInst().subscribe("onCollectHighlightsWeb",this.onCollectHighlightsWeb,this),window.postMessage({method:"collectHighlightsWeb",type:"1757FROM_PAGERW4G",documentHighlights:i},"*")}function onGetSettingsChanged(){try{textHelp.webreaderapi.EventBusSingleton.getInst().unsubscribe(g_eventSubScribeID)}catch(e){window.console.error(e.stack)}}function onCollectHighlightsWeb(e){try{g_notifID.remove(),textHelp.webreaderapi.EventBusSingleton.getInst().unsubscribe(g_eventSubScribeCollectID),g_collectHighlightsTab.location=e,g_collectHighlightsTab.focus()}catch(e){window.console.error(e.stack)}}function onVocabWeb(e){try{g_notifID.remove(),textHelp.webreaderapi.EventBusSingleton.getInst().unsubscribe(g_eventSubScribeVocabID),g_vocabTab.location=e,g_vocabTab.focus()}catch(e){window.console.error(e.stack)}}function onCancelCHDialog(){textHelp.webreaderapi.EventBusSingleton.getInst().unsubscribe(g_eventSubScribeID);var e=document.querySelector("#thCHDialog");null!==e&&e.parentNode.removeChild(e);var t=document.querySelector("#thSSCHODialog");null!==t&&t.parentNode.removeChild(t),g_showTHCHDialog=!1}function onGetSettingsChanged(e){try{if(e.thRWFGSettings==void 0)return;var t=document.querySelector("#thCHDialog");if(null!==t)return;if(g_showTHCHDialog)return;g_showTHCHDialog=!0,showDialogwithSetting(window.JSON.parse(e.thRWFGSettings))}catch(e){window.console.error(e.stack)}}function studySkillsCollate(){try{return showDialog(),""}catch(e){return thLog("Error in method: "+e.name+" "+e.message+" "+e.toString()),""}}function collateFilter(e){if(-1<e.indexOf("\\")||-1<e.indexOf("~")||-1<e.indexOf("|")){var t,n;for(n=0;n<e.length;n++)t=e.charCodeAt(n),126==t?(e=e.substring(0,n)+"\\h"+e.substr(n+1),++n):124==t?(e=e.substring(0,n)+"\\v"+e.substr(n+1),++n):92==t&&(e=e.substring(0,n)+"\\\\"+e.substr(n+1),++n)}return e}function studySkillsCollateValuesOnly(){try{var e,t=studySkillsCollateForColourValuesOnly("cyan");e=t;var n=studySkillsCollateForColourValuesOnly("magenta");0<e.length&&0<n.length&&(e+="|"),e+=n;var o=studySkillsCollateForColourValuesOnly("yellow");0<e.length&&0<o.length&&(e+="|"),e+=o;var i=studySkillsCollateForColourValuesOnly("orange");0<e.length&&0<i.length&&(e+="|"),e+=i;var d=studySkillsCollateForColourValuesOnly("lightgreen");return 0<e.length&&0<d.length&&(e+="|"),e+=d,e}catch(e){return thLog("Error in method: "+e.name+" "+e.message+" "+e.toString()),""}}function rw_selectCollateText(){var e=document.getElementById("rwcollatewrapper");if(null!=e){if(g_bIEOld){var t=SSDOM.getRangeObject(e.ownerDocument.body);t.moveToElementText(e),t.select()}else{var n=SSDOM.getNextNodeIgnoreChildren(e,!1,null);if(null!=n){var t=new THDomRange(e,0,n,0);rw_selectSection(t)}}try{var o=g_controllerFactory.getConnector();if(null!=o){var i=rw_getSelectionNonParsed();null==i||0==i.length||o.setToClipboard(i.valueOf())}}catch(e){thLogE(e)}}}function $rw_getHighlights(e){return e=e.toLowerCase(),"blue"==e?e="cyan":"red"==e&&(e="magenta"),"green"==e&&(e="lightgreen"),studySkillsCollateForColour(e)}function getColor(e){return e=e.toLowerCase(),"cyan"==e?e="blue":"magenta"==e&&(e="pink"),"lightgreen"==e&&(e="green"),e}function studySkillsCollateForColour(e){for(var t,n=[],o=[],i=g_aTextRange.length,d=0,s=0;s<i;s++)if(t=getColor(g_aHighlightColour[s]),-1!=e.indexOf(t)){var l=g_aTextRange.slice(s,s+1).pop();l.color=t,n.push(l)}g_bIEOld?n.sort(sortBy):n.sort(sortBySFF);for(var a,c=n.length,s=0;s<c;s++){var r,g=n[s].color;if(g_bIEOld){var h=n.slice(s,s+1).pop(),u=rw_getTextRangeAsTHRange(h.parentElement().ownerDocument.body,h);r=rw_getTHCaretRangeFromTHRange(u)}else r=rw_getTHCaretRangeFromTHDomRange(n[s]);a=SSDOM.getTextOverCaretRange(r),0<a.length&&(a=rw_filterForHtml(a),d++,o.push({text:a,color:g}))}return o}function studySkillsCollateForColourValuesOnly(e){for(var t,n=[],o=g_aTextRange.length,i="",d="",s=0;s<o;s++)t=g_aHighlightColour[s],t==e&&n.push(g_aTextRange.slice(s,s+1).pop());g_bIEOld?n.sort(sortBy):n.sort(sortBySFF);for(var l,a=n.length,s=0;s<a;s++)l=g_bIEOld?n.slice(s,s+1).pop().text:n[s].toString(),0<l.length&&(d+="~"+collateFilter(l));return 0<d.length&&(i+=e,i+=d),i}function hasStudySkills(){return null!=g_aTextRange&&0<g_aTextRange.length}function $rw_event_cyan(){try{stopTexthelpScreenshotReading(),studySkillsHTMLHighlightRange("cyan")}catch(e){thLogE(e)}}function $rw_event_magenta(){try{stopTexthelpScreenshotReading(),studySkillsHTMLHighlightRange("magenta")}catch(e){thLogE(e)}}function $rw_event_yellow(){try{stopTexthelpScreenshotReading(),studySkillsHTMLHighlightRange("yellow")}catch(e){thLogE(e)}}function $rw_event_orange(){try{stopTexthelpScreenshotReading(),studySkillsHTMLHighlightRange("orange")}catch(e){thLogE(e)}}function $rw_event_green(){try{stopTexthelpScreenshotReading(),studySkillsHTMLHighlightRange("lightgreen")}catch(e){thLogE(e)}}function $rw_event_strike(){try{studySkillsHTMLHighlightRange("strikethrough")}catch(e){thLogE(e)}}function $rw_event_clear(){try{stopTexthelpScreenshotReading(),studySkillsClearHighlights(!1)}catch(e){thLogE(e)}}function $rw_clearAllHighlights(){studySkillsClearHighlights(!0)}function $rw_refreshHighlights(){var e=g_bPersistAnnotations;g_bPersistAnnotations=!1,g_strStoredHighlightData=null,g_strStoredHighlightUnprocessedData=null,studySkillsClearHighlights(!0),g_bPersistAnnotations=e,rw_retrieveHighlightDataForPKT()}function $rw_event_collect(){try{stopTexthelpScreenshotReading(),rw_doCollect()}catch(e){thLogE(e)}}function $rw_event_vocabulary(){try{stopTexthelpScreenshotReading(),new SpeechStream.Vocab().sendRequest()}catch(e){thLogE(e)}}function studySkillsHTMLRefreshRanges(){try{var e=null,t=!1,n=0;for(n=0;n<g_aTextRange.length;n++){e=g_aTextRange[n];try{(null==e.text||""==e.text)&&(e=null)}catch(t){thLogE(t),e=null}null==e&&(g_aTextRange.splice(n,1),g_aHighlightColour.splice(n,1),t=!0,n--)}return t}catch(e){return thLog("Error in method studySkillsHTMLRefreshRanges: "+e.toString()),!1}}var rw_SSPostCallback=function(e){try{eval(e)}catch(e){}};function rw_submitSSDataWithPost(e){var t=null==g_strHighlightStorageUrl?g_strPersistStorageUrl:g_strHighlightStorageUrl;var n=rw_getHTTPText(!1)+t+"/stickynoteserver/",o="cmd="+CMD_ADD_SSDATA;g_bPktFlag||(o+="&custid="+rw_custEscape(g_strCustId)),o+="&titleid="+rw_custEscape(g_strBookId),o+="&pageid="+rw_custEscape(g_strPageId),o+="&teacherid="+rw_custEscape(g_strPersistHighlightReaderId),o+="&studentid="+rw_custEscape(g_strPersistHighlightEditorId);var i=e[0],d=e[1];o+="&ssdata="+rw_custEscape(i),null!=d&&(o+="&highlighttext="+d);var s=new SpeechStream.AjaxRequest;s.doPost(n,o,rw_SSPostCallback,null,!1)}function rw_submitSSDataWithGet(e){var t=null==g_strHighlightStorageUrl?g_strPersistStorageUrl:g_strHighlightStorageUrl;var n=rw_getHTTPText(!1)+t+"/stickynoteserver/?"+CMD_CODE+"="+CMD_ADD_SSDATA;g_bPktFlag||(n+="&custid="+rw_custEscape(g_strCustId)),n+="&titleid="+rw_custEscape(g_strBookId),n+="&pageid="+rw_custEscape(g_strPageId),n+="&teacherid="+rw_custEscape(g_strPersistHighlightReaderId),n+="&studentid="+rw_custEscape(g_strPersistHighlightEditorId);var o=e[0],i=e[1];n+="&ssdata="+rw_custEscape(o),null!=i&&(n+="&highlighttext="+encodeURIComponent(i));var d=document.createElement("script");d.type="text/javascript",d.src=n,document.body.appendChild(d)}function rw_submitViaFlash(e){var t=g_controllerFactory.getConnector();if(null!=t){var n,o=e[0],i=e[1];n=null==g_strHighlightStorageUrl?g_strPersistStorageUrl:g_strHighlightStorageUrl;var d=rw_getHTTPText(!1)+n+"/stickynoteserver/",s=CMD_ADD_SSDATA,l=g_bPktFlag?null:g_strCustId,a=g_strBookId,c=g_strPageId,r=g_strPersistHighlightReaderId,g=g_strPersistHighlightEditorId;t.storeIEHighlightData(d,s,l,a,c,r,g,o,i)}}function $rw_submitViaFlashCallback(e){eval(e)}var g_nHighlightNotSyncedState=0;function rw_getStudySkillsPositionData(){var e=g_aTextRange.length,t="",n=null;g_bStoreHighlightText&&(n="|");try{for(var o=0;o<e;o++){t+="|";var i=g_aHighlightColour[o];t+=i+"|";var d,s,l,a=g_aTextRange[o];if(g_bIEOld){g_bStoreHighlightText&&(l=a.text);var c=rw_getTextRangeAsTHRange(a.body,a);d=c.startRef,s=c.endRef}else{a.refresh(),g_bStoreHighlightText&&(l=a.toString());var r=a.startCaret.node,g=a.startCaret.offset,h=a.endCaret.node,u=a.endCaret.offset;if(3==r.nodeType&&0==r.nodeValue.trimTH().length){for(r=SSDOM.getNextNode(r,!1,h),g=0;null!=r&&3==r.nodeType&&0==r.nodeValue.trimTH().length;)r=SSDOM.getNextNode(r,!1,h);null==r&&(r=h)}var f=rw_getRefPt(r,g);if(3==h.nodeType&&0==h.nodeValue.trimTH().length){for(u=0;r!=h&&null!=h&&3==h.nodeType&&0==h.nodeValue.trimTH().length;)h=SSDOM.getPreviousNode(h,!1,r);null!=h&&3==h.nodeType&&0<h.nodeValue.trimTH().length&&(u=h.nodeValue.length)}var p=rw_getRefPt(h,u);d=f,s=p}if(null!=d&&null!=s){var b=SSDOM.getCaretPairFromDomPosition(a.body,d.path,d.offset,s.path,s.offset),m=b.leftCaret,x=b.rightCaret;t+=rw_convertToPermCaretPosition(m)+"|"+rw_convertToPermCaretPosition(x),g_bStoreHighlightText&&(l=rw_replaceAll(l,"|","&#124;"),n+=encodeURIComponent(l)+"|")}}0<t.length&&(t+="|*188")}catch(e){thLogE(e)}return[t,n]}function rw_convertToPermCaretPosition(e){var t=e.node.ownerDocument.body,n=e.node,o=e.offset;o+=rw_getNodeOffset(n);for(var i=n.parentNode,d=i.getAttribute("id");(null==d||0==d.length)&&i!=t;)o+=rw_getNodeOffset(i),i=i.parentNode,d=i.getAttribute("id");if(!(null!=d&&0<d.length)){var s=rw_getRefPt(e.node,e.offset);strPos=s.path,o=s.offset}else if(strPos="idx"+d,null!=i&&null!=i.firstChild){var l=SSDOM.getFirstChildTextNode(i,!1);if(3==l.nodeType){for(var a=0,c=l.nodeValue;c.length>a&&32==c.charCodeAt(a);)++a;o-=a}}return strPos+"|"+o}function rw_convertFromPermCaretPosition(e,t,n){var o=SSDOM.getPositionInDom(e),i=0;if(n&&null!=e.firstChild){var d=SSDOM.getFirstChildTextNode(e,!1);if(null==d)return null;if(3==d.nodeType)for(var s=d.nodeValue;s.length>i&&32==s.charCodeAt(i);)++i}return new THDomRefPt(o,t+i)}function rw_restoreHighlights(e){var t=!1;if(4<e.length){var n=e.substr(e.length-4);if("*"==n.charAt(0)){var o=parseInt(n.substr(n.length-3),10);188<=o&&(t=!0)}}for(var i,d,s,l,a,c,r,g,h=e.indexOf("|"),u=e.indexOf("|",h+1),f=e.indexOf("|",u+1),p=e.indexOf("|",f+1),b=e.indexOf("|",p+1),m=e.indexOf("|",b+1);-1<h&&-1<u&&-1<f&&-1<p&&-1<b&&-1<m;){g=!0,i=e.substring(h+1,u),d=e.substring(u+1,f),s=e.substring(f+1,p),a=e.substring(p+1,b),c=e.substring(b+1,m),l=parseInt(s,10),r=parseInt(c,10);var x=document.body;if(3<d.length&&"idx"==d.substring(0,3)){var k=rw_getElementById(d.substr(3));if(null==k)g=!1;else{x=k.ownerDocument.body;var S=rw_convertFromPermCaretPosition(k,l,t);null==S?g=!1:(d=S.path,l=S.offset)}}if(3<a.length&&"idx"==a.substring(0,3)){var k=rw_getElementById(a.substr(3));if(null==k)g=!1;else{x=k.ownerDocument.body;var S=rw_convertFromPermCaretPosition(k,r,t);null==S?g=!1:(a=S.path,r=S.offset)}}if(g){var v=null;if(g_bIEOld)v=rw_getAsTextRange(x,d,l,a,r);else{var y=SSDOM.getCaretPairFromDomPosition(x,d,l,a,r),C=y.leftCaret,w=y.rightCaret;null!=C&&null!=w&&(v=new THDomRange(C.node,C.offset,w.node,w.offset))}null==v?g=!1:studySkillsHTMLHighlightRangeImpl(v,i)}g||(null==g_strStoredHighlightUnprocessedData&&(g_strStoredHighlightUnprocessedData=""),g_strStoredHighlightUnprocessedData+=e.substring(h,m)),h=m,u=e.indexOf("|",h+1),f=e.indexOf("|",u+1),p=e.indexOf("|",f+1),b=e.indexOf("|",p+1),m=e.indexOf("|",b+1)}}function rw_storeHighlightData(){g_bAnnotationGlobalCheck&&rw_forceUseAnnotations();var e=rw_getStudySkillsPositionData();null==g_strStoredHighlightUnprocessedData?g_nHighlightNotSyncedState=0:(e[0]=g_strStoredHighlightUnprocessedData+e[0],g_bStoreHighlightText&&(g_nHighlightNotSyncedState=1)),g_strStoredHighlightData=null,g_bIE&&!g_controllerFactory.doesSupportHtml5()?rw_submitViaFlash(e):g_bStoreHighlightText?rw_submitSSDataWithPost(e):rw_submitSSDataWithGet(e)}function rw_storeHighlightCallback(e){eval(e)}function rw_retrieveHighlightDataForPKT(){if(SpeechStream.annotateBlock.m_bUseAnnotations){if(null!=g_strStoredHighlightData)return void $rw_retrieveHighlightDataForPKTReply(g_strStoredHighlightData);if(!g_bAnnotationGlobalCheck||g_bAnnotationGlobalAllowed){var e,t=new Date,n=t.getTime();e=null==g_strHighlightStorageUrl?g_strPersistStorageUrl:g_strHighlightStorageUrl;var o=rw_getHTTPText(!1)+e+"/stickynoteserver/?"+CMD_CODE+"=";o+=g_bAnnotationGlobalCheck&&g_bAnnotationGlobalUnknown?CMD_RETRIEVE_SSDATA_EXTRA:CMD_RETRIEVE_SSDATA,g_bPktFlag||(o+="&custid="+rw_custEscape(g_strCustId)),o+="&titleid="+rw_custEscape(g_strBookId),o+="&pageid="+rw_custEscape(g_strPageId),o+="&teacherid="+rw_custEscape(g_strPersistHighlightReaderId),o+="&studentid="+rw_custEscape(g_strPersistHighlightEditorId),o+="&"+n+Math.floor(111*Math.random());var i=document.createElement("script");i.type="text/javascript",i.src=o,document.body.appendChild(i)}}}var g_strStoredHighlightData=null,g_strStoredHighlightUnprocessedData=null;function $rw_retrieveHighlightDataForPKTReply(e){var t=g_bIgnoreHidden;try{"boolean"!=typeof eba_ignore_hidden||eba_ignore_hidden||(g_bIgnoreHidden=!1),"[e2020-nomatch]"==e?rw_setNotUsingAnnotations():g_bAnnotationGlobalCheck&&g_bAnnotationGlobalUnknown&&rw_setUsingAnnotations();var n;2==g_nHighlightNotSyncedState&&(n=g_strStoredHighlightUnprocessedData),g_strStoredHighlightUnprocessedData=null,rw_restoreHighlights(e),g_strStoredHighlightData=e,2==g_nHighlightNotSyncedState&&(n!=g_strStoredHighlightUnprocessedData&&rw_storeHighlightData(),g_nHighlightNotSyncedState=null==g_strStoredHighlightUnprocessedData?0:1)}catch(e){thLog(e.message)}"boolean"!=typeof eba_ignore_hidden||eba_ignore_hidden||(g_bIgnoreHidden=t),"*"!=g_strPersistNoteEditorId&&"undefined"!=typeof rw_unserialiseStickyNotes&&rw_unserialiseStickyNotes()}SpeechStream.Vocab=function(){this.m_bSentenceSelection=!1},SpeechStream.Vocab.prototype.fetchWords=function(){for(var e=[],t=[],n=g_aTextRange.length,o=0;o<n;o++){var i;if(i=g_bIEOld?g_aTextRange.slice(o,o+1).pop().text:g_aTextRange[o].toString(),-1!=i.trimTH().indexOf(" "))this.m_bSentenceSelection=!0;else if(t.push(g_aTextRange.slice(o,o+1).pop()),t.length>=g_nVocabLimit&&-1!=g_nVocabLimit)break}g_bIEOld?t.sort(sortBy):t.sort(sortBySFF);for(var d,s=t.length,l=0;l<s;l++){d=g_bIEOld?t.slice(l,l+1).pop().text:t[l].toString(),d=d.trim();var a=".,?!";a=function(e){return e.replace(/[\[\](){}?*+\^$\\.|\-]/g,"\\$&")}(a),d=d.replace(new RegExp("^["+a+"]+|["+a+"]+$","g"),""),e.push(d)}return e},SpeechStream.Vocab.prototype.generateRequestData=function(){var e=this.fetchWords();if(0==e.length)return this.m_bSentenceSelection?alert(textHelp.webreader.LocaleSingleton.getInst().getLocaleString("speechstream_msh_singlewordnoselection")):alert(textHelp.webreader.LocaleSingleton.getInst().getLocaleString("speechstream_msh_noselection")),null;var t=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("vocab_notification"),n=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("vocab_notification_text");g_notifID=window.notification({msg:"<div><div class=\"vl-notification\"><div class=\"vl-notification-content\"><div class=\"vl-notification-heading\">"+t+"</div><div class=\"vl-notification-msg\">"+n+"</div></div></div></div>",sticky:!0,type:"success",animIn:"fadeInRight",animOut:"fadeOutDown"}),g_vocabTab=window.open("","_blank");var o=textHelp.webreader.ConfigurationSingleton.getInst().getConfiguration(),i={};i.words=e,i.locale=o.locale,i.user=o.serversettings.user,i.translations={},i.translations.docTitle=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("vocab_document_title"),i.translations.title=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("vocab_title"),i.translations.heading=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("vocab_word_heading"),i.translations.symbol=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("vocab_word_symbol"),i.translations.notes=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("vocab_word_notes"),i.translations.meaning=textHelp.webreader.LocaleSingleton.getInst().getLocaleString("vocab_word_meaning"),i.locale=textHelp.webreader.UserSettingsSingleton.getInst().getUserSettings().language.services,g_eventSubScribeVocabID=textHelp.webreaderapi.EventBusSingleton.getInst().subscribe("onVocabWeb",onVocabWeb,this),window.postMessage({method:"vocabWeb",type:"1757FROM_PAGERW4G",payload:i},"*")},SpeechStream.Vocab.prototype.sendRequest=function(){this.generateRequestData()};