var Background={extId:null,user:null,preferences:null,savings:0,lookupConfig:function(e){var n=this,t=e.tab.id,r=e.tab.url,o=Url.getHost(r),a=this.getUser()&&this.getUser().hasOwnProperty("auth")?this.getUser().auth:null;$.getJSON(Config.server+"/toolbar/config?host="+encodeURIComponent(o)+"&cb="+encodeURIComponent(Math.random(1e4))+"&app_uid="+encodeURIComponent(this.getExtId())+(a?"&auth="+a:"")+"&callback=?",{},function(e){var o=e.ruleset,s=e.codes,i=e.hasOwnProperty("codeDetails")?e.codeDetails:null,c=e.hasOwnProperty("cashback")?e.cashback:null,u=e.hasOwnProperty("cookieDomain")?e.cookieDomain:null,d=e.hasOwnProperty("flags")?e.flags:null,g=e.hasOwnProperty("earnings")?e.earnings:null,f=e.hasOwnProperty("savings")?e.savings:null;"undefined"!=typeof window.afSrc&&(delete window.afSrc,c instanceof Object?c.suppressPrompts=!0:c={suppressPrompts:!0}),s instanceof Array&&o instanceof Object||c instanceof Object?(chrome.tabs.sendMessage(t,{action:"saveConfig",ruleset:o,codes:s,codeDetails:i,cashback:c,cookieDomain:u,flags:d}),chrome.tabs.sendMessage(t,{action:"testForCheckout",url:r})):chrome.tabs.sendMessage(t,{action:"setStateConfigReceived"}),a&&g&&n.setUser({auth:n.getUser().auth,apiKey:n.getUser().apiKey,earnings:g}),f&&n.setSavings(f)})},setBadge:function(e,n,t){if(n instanceof Array&&!(0===n.length&&t instanceof Array)&&!(t instanceof Object&&t.suppressPrompts)){var r=e.tab.id;chrome.tabs.get(r,function(e){chrome.browserAction.setBadgeBackgroundColor({color:[67,189,59,155],tabId:r}),chrome.browserAction.setIcon({path:"icons/p/flat-icon-19.png",tabId:r}),chrome.browserAction.setBadgeText({text:n.length>0?n.length.toString():t&&t.hasOwnProperty("pay")?"$$":"",tabId:r})})}},setPopup:function(e,n){chrome.tabs.get(e,function(t){chrome.browserAction.setPopup({tabId:e,popup:n})})},broadcast:function(e){chrome.tabs.sendMessage(e,{action:"initStorage",extId:this.extId,user:this.user,preferences:this.preferences,savings:this.savings})},broadcastAll:function(){var e=this;chrome.tabs.query({},function(n){for(var t in n)e.broadcast(n[t].id)})},initStorage:function(e,n){var t=this;chrome.storage.local.get(["_cofund.id","_cofund.auth","_cofund.hasReviewed","_cofund.appKey","_cofund.earnings","_cofund.preferences","_cofund.savings","_cofund.reviewTimeLimit"],function(r){if(r.hasOwnProperty("_cofund.id"))t.extId=r["_cofund.id"],CoFund.Info.setExtId(t.extId);else{var o=t._getRandomId();chrome.storage.local.set({"_cofund.id":o},function(){}),console.log("Extension id assigned",o),t.extId=o,CoFund.Info.setExtId(t.extId)}r.hasOwnProperty("_cofund.hasReviewed")?CoFund.Info.hasReviewed=r["_cofund.hasReviewed"]:chrome.storage.local.set({"_cofund.hasReviewed":!1}),r.hasOwnProperty("_cofund.reviewTimeLimit")?CoFund.Info.reviewTimeLimit=r["_cofund.reviewTimeLimit"]:chrome.storage.local.set({"_cofund.reviewTimeLimit":0}),r.hasOwnProperty("_cofund.auth")&&r.hasOwnProperty("_cofund.appKey")&&r.hasOwnProperty("_cofund.earnings")&&(t.user={auth:r["_cofund.auth"],appKey:r["_cofund.appKey"],earnings:r["_cofund.earnings"]},CoFund.Info.setUser(t.user)),r.hasOwnProperty("_cofund.preferences")&&(t.preferences=$.extend(Config.defaultPreferences,JSON.parse(r["_cofund.preferences"])),CoFund.Info.setPreferences(t.preferences)),r.hasOwnProperty("_cofund.savings")&&(t.savings=parseFloat(r["_cofund.savings"]),CoFund.Info.setSavings(t.savings)),e&&t.broadcast(e),n&&n(t.extId,t.user,t.preferences,t.savings)})},getExtId:function(){return this.extId},getUser:function(){return this.user},setUser:function(e){var n=this;chrome.storage.local.set({"_cofund.auth":e.auth,"_cofund.appKey":e.app_key,"_cofund.earnings":e.earnings},function(){n.user={auth:e.auth,appKey:e.app_key,earnings:e.earnings},n.broadcastAll()})},clearUser:function(){var e=this;chrome.storage.local.remove(["_cofund.auth","_cofund.appKey","_cofund.earnings"],function(){e.user={auth:null,appKey:null,earnings:null},e.broadcastAll()})},getPreferences:function(){return this.preferences},setPreferences:function(e){var n=this,t=$.extend(Config.defaultPreferences,e);chrome.storage.local.set({"_cofund.preferences":JSON.stringify(t)},function(){n.preferences=t,n.broadcastAll()})},getSavings:function(){return this.savings},setSavings:function(e){var n=this;chrome.storage.local.set({"_cofund.savings":parseFloat(e)},function(){n.savings=parseFloat(e),n.broadcastAll()})},addSavings:function(e,n,t,r){var o=this,a=Url.getHost(r);chrome.storage.local.set({"_cofund.savings":this.savings+parseFloat(e)},function(){o.savings+=parseFloat(e),o.broadcastAll(),$.ajax({type:"POST",url:Config.server+"/toolbar/savedYouMoney?app_uid="+o.getExtId(),data:{s:n,o:t,savings:e,domain:a,auth:o.getUser()?o.getUser().auth:""}})})},_getRandomId:function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}};chrome.runtime.onMessage.addListener(function(e,n,t){switch(e.action){case"start":if(!n.hasOwnProperty("tab")||!n.tab)return;if("newtab"===n.tab.url)return;Background.initStorage(n.tab.id,function(){var t=e.state;t?(Background.setBadge(n,e.codes,e.cashback),Background.setPopup(n.tab.id,"src/popup/popup.html")):(Background.lookupConfig(n),Background.setPopup(n.tab.id,"src/popup/popup.html"))});break;case"setBadge":Background.setBadge(n,e.codes,e.cashback);break;case"setPopup":Background.setPopup(n.tab.id,e.popup);break;case"loadExternalProvider":chrome.tabs.executeScript(n.tab.id,{code:e.script},function(){chrome.runtime.lastError&&CoFund.Events.logProviderError("Error loading ExternalProvider: "+chrome.runtime.lastError.message)});break;case"firePixel":$.ajax({type:"GET",url:e.url,cache:!1,timeout:Config.ajaxTimeouts.cashbackPixel,success:function(e,n,t){CoFund.Events.logCashbackFired()},error:function(e){CoFund.Events.logCashbackFireFailed()}});break;case"openTab":chrome.tabs.create({url:e.url,active:!1,openerTabId:n.tab.id},function(e){Config.waitFor.backgroundPixel&&setTimeout(function(){chrome.tabs.remove(e.id)},Config.waitFor.backgroundPixel)});break;case"getExtId":return Background.getExtId();case"getUser":return Background.getUser();case"setUser":e.hasOwnProperty("user")&&Background.setUser(e.user);break;case"clearUser":Background.clearUser();break;case"getPreferences":return Background.getPreferences();case"setPreferences":e.hasOwnProperty("preferences")&&Background.setPreferences(e.preferences);break;case"getSavings":return Background.getSavings();case"setSavings":Background.setSavings(e.savings);break;case"addSavings":e.hasOwnProperty("savings")&&Background.addSavings(e.savings,e.storeId||0,e.offerId||0,n.tab.url);break;case"checkReview":!CoFund.Info.hasReviewed&&Date.now()>CoFund.Info.reviewTimeLimit&&t(!0);break;case"reviewLater":chrome.storage.local.set({"_cofund.reviewTimeLimit":Date.now()+2592e5});break;case"addReview":chrome.tabs.create({url:"https://chrome.google.com/webstore/detail/"+chrome.runtime.id+"/reviews"},function(){chrome.storage.local.set({"_cofund.hasReviewed":!0},function(){CoFund.Info.hasReviewed=!0}),$.ajax({type:"POST",url:Config.server+"/api/logreview",data:{token:Config.apiToken,app_uid:Background.getExtId(),auth:Background.getUser()&&Background.getUser().hasOwnProperty("auth")?Background.getUser().auth:null,has_reviewed:1}})})}}),chrome.tabs.onUpdated.addListener(function(e,n,t){"complete"==n.status&&chrome.tabs.sendMessage(e,{action:"testForCheckout",url:t.url})}),chrome.browserAction.onClicked.addListener(function(e){chrome.tabs.sendMessage(e.id,{action:"showPageDrawer"})}),chrome.runtime.onInstalled.addListener(function(e){"install"===e.reason?Background.initStorage(null,function(e){chrome.tabs.create({url:Config.server+"/api/install?app_uid="+e+"&v="+Config.version+"&token="+Config.apiToken+"&r=thankyou"},function(n){chrome.tabs.executeScript(n.id,{code:"var toolbar = document.createElement('TOOLBAR'); toolbar.id = 'browserappinstalled'; toolbar.setAttribute('app_uid', '"+e+"'); toolbar.setAttribute('version', '"+Config.version+"'); document.body.appendChild(toolbar);"},function(n){console.log("Extension installed",e)})}),chrome.runtime.setUninstallURL(Config.server+"/toolbar/uninstall?app_uid="+e,function(){})}):"update"===e.reason&&Background.initStorage(null)}),chrome.webRequest.onBeforeRequest.addListener(function(e){-1!==e.url.indexOf("afsrc=1")&&(window.afSrc=!0)},{urls:["*://*/*"]});
//# sourceMappingURL=chrome-minified/src/bg/background.js.map